<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Yönetici Paneli - Anket Yönetimi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 30px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { margin: 0; font-size: 28px; font-weight: 600; }
    
    .main-content { padding: 30px 40px; }
    
    /* Dropdown Button */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-btn {
      background: #fff;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
    }
    .dropdown-btn:hover { background: #f0f4ff; }
    .dropdown-content {
      display: none;
      position: absolute;
      background: #fff;
      min-width: 300px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      border-radius: 12px;
      z-index: 1000;
      margin-top: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    .dropdown.active .dropdown-content { display: block; }
    .dropdown-item {
      padding: 14px 20px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }
    .dropdown-item:hover { background: #f8f9ff; }
    .dropdown-item:last-child { border-bottom: none; }
    .dropdown-item.selected { background: #e8edff; font-weight: 600; }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary { background: #667eea; color: #fff; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .btn-success { background: #10b981; color: #fff; }
    .btn-success:hover { background: #059669; transform: translateY(-2px); }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; transform: translateY(-2px); }
    .btn-secondary { background: #6b7280; color: #fff; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-outline { background: transparent; border: 2px solid #667eea; color: #667eea; }
    .btn-outline:hover { background: #667eea; color: #fff; }
    
    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .panel {
      background: #f9fafb;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .panel-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1f2937;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
    }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content {
      background: #fff;
      border-radius: 20px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-title {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #9ca3af;
    }
    .modal-close:hover { color: #ef4444; }
    
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      transition: border 0.3s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    /* Question Card */
    .question-card {
      background: #fff;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: move;
      transition: all 0.3s;
    }
    .question-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #667eea;
    }
    .question-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .question-order {
      font-weight: 700;
      color: #667eea;
      font-size: 18px;
    }
    
    /* Toggle Switch */
    .toggle {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 28px;
    }
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: 0.4s;
      border-radius: 28px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    .toggle input:checked + .toggle-slider {
      background-color: #10b981;
    }
    .toggle input:checked + .toggle-slider:before {
      transform: translateX(28px);
    }
    
    /* Stats Card */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 24px;
      border-radius: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    /* Section Tabs */
    .section-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .section-tab {
      padding: 10px 20px;
      background: #e5e7eb;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-tab.active {
      background: #667eea;
      color: #fff;
    }
    .section-tab:hover:not(.active) {
      background: #d1d5db;
    }
    .section-delete {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      margin-left: 4px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }
    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .question-actions {
      display: flex;
      gap: 8px;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .view-mode {
      display: none;
    }
    .view-mode.active {
      display: block;
    }
    
    /* Şablon seçim */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .template-card {
      padding: 16px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      font-weight: 600;
    }
    .template-card:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📊 Anket Yönetim Paneli</h1>
    </div>
    
    <div class="main-content">
      <!-- Anketler Dropdown ve Toolbar -->
      <div class="toolbar">
        <div class="dropdown" id="surveysDropdown">
          <button class="dropdown-btn" onclick="toggleDropdown()">
            <span id="selectedSurveyText">Anket Seçin</span>
            <span>▼</span>
          </button>
          <div class="dropdown-content" id="surveysDropdownContent"></div>
        </div>
        <button class="btn btn-primary" onclick="showNewSurveyModal()">+ Yeni Anket</button>
      </div>
      
      <!-- Ana İçerik Görünümleri -->
      <div id="noSurveyView" class="view-mode active">
        <div class="empty-state">
          <div class="empty-state-icon">📋</div>
          <h2>Henüz anket seçilmedi</h2>
          <p>Yukarıdan bir anket seçin veya yeni anket oluşturun.</p>
        </div>
      </div>
      
      <div id="surveyManagementView" class="view-mode">
        <!-- Anket Bilgileri ve Yönetim -->
        <div class="panel">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
              <h2 style="margin: 0; color: #1f2937;" id="currentSurveyTitle"></h2>
              <p style="margin: 4px 0; color: #6b7280;" id="currentSurveySlug"></p>
            </div>
            <label class="checkbox-label">
              <span style="font-weight: 600;">Aktif</span>
              <label class="toggle">
                <input type="checkbox" id="surveyActiveToggle" onchange="toggleSurveyActive()">
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>
          
          <div class="toolbar">
            <button class="btn btn-primary" onclick="showQuestionsView()">📝 Anket Soruları</button>
            <button class="btn btn-outline" onclick="showStatsModal()">📊 İstatistikler</button>
            <button class="btn btn-outline" onclick="showUpdateSurveyModal()">✏️ Güncelle</button>
            <button class="btn btn-success" onclick="exportSurveyData()">📥 Veriyi İndir (XLSX)</button>
            <button class="btn btn-danger" onclick="deleteSurvey()">🗑️ Sil</button>
          </div>
        </div>
      </div>
      
      <div id="questionsView" class="view-mode">
        <!-- Soru Yönetimi -->
        <div class="panel">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="backToSurveyManagement()">← Geri</button>
            <div style="display: flex; gap: 12px; align-items: center;">
              <label class="checkbox-label">
                <span style="font-weight: 600;">Bölümlere Ayır</span>
                <label class="toggle">
                  <input type="checkbox" id="sectionsToggle" onchange="toggleSections()">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <button class="btn btn-outline" id="addSectionBtn" style="display: none;" onclick="showAddSectionModal()">+ Bölüm Ekle</button>
              <button class="btn btn-success" onclick="saveQuestions()">💾 Kaydet</button>
            </div>
          </div>
          
          <div id="sectionTabs" class="section-tabs" style="display: none;"></div>
          
          <div class="toolbar">
            <button class="btn btn-primary" onclick="addQuestion()">+ Soru Ekle</button>
            <button class="btn btn-outline" onclick="showTemplatesModal()">📋 Şablon Seç</button>
          </div>
          
          <div id="questionsContainer"></div>
          <div id="statusMessage" style="margin-top: 16px; color: #059669; font-weight: 600;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Yeni Anket Modal -->
  <div id="newSurveyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Yeni Anket Oluştur</h2>
        <button class="modal-close" onclick="closeModal('newSurveyModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">Anket Linki (Slug)</label>
        <input type="text" class="form-input" id="newSurveySlug" placeholder="ornek-anket">
      </div>
      <div class="form-group">
        <label class="form-label">Anket Başlığı</label>
        <input type="text" class="form-input" id="newSurveyTitle" placeholder="Müşteri Memnuniyet Anketi">
      </div>
      <button class="btn btn-primary" style="width: 100%;" onclick="createSurvey()">Kaydet</button>
    </div>
  </div>
  
  <!-- Anket Güncelle Modal -->
  <div id="updateSurveyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Anketi Güncelle</h2>
        <button class="modal-close" onclick="closeModal('updateSurveyModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">Anket Linki (Slug)</label>
        <input type="text" class="form-input" id="updateSurveySlug">
      </div>
      <div class="form-group">
        <label class="form-label">Anket Başlığı</label>
        <input type="text" class="form-input" id="updateSurveyTitle">
      </div>
      <button class="btn btn-primary" style="width: 100%;" onclick="updateSurvey()">Güncelle</button>
    </div>
  </div>
  
  <!-- İstatistikler Modal -->
  <div id="statsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Anket İstatistikleri</h2>
        <button class="modal-close" onclick="closeModal('statsModal')">&times;</button>
      </div>
      <div class="stats-grid" id="statsContent"></div>
    </div>
  </div>
  
  <!-- Şablonlar Modal -->
  <div id="templatesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Hazır Şablonlar</h2>
        <button class="modal-close" onclick="closeModal('templatesModal')">&times;</button>
      </div>
      <div class="template-grid">
        <div class="template-card" onclick="applyTemplate('NPS')">📊 NPS</div>
        <div class="template-card" onclick="applyTemplate('Likert5')">⭐ Likert (5)</div>
        <div class="template-card" onclick="applyTemplate('Demografi')">👥 Demografi</div>
        <div class="template-card" onclick="applyTemplate('Sehir')">🏙️ Şehir (81 İl)</div>
      </div>
    </div>
  </div>
  
  <!-- Bölüm Ekle Modal -->
  <div id="addSectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Yeni Bölüm Ekle</h2>
        <button class="modal-close" onclick="closeModal('addSectionModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">Bölüm Adı</label>
        <input type="text" class="form-input" id="newSectionName" placeholder="Demografi">
      </div>
      <button class="btn btn-primary" style="width: 100%;" onclick="createSection()">Ekle</button>
    </div>
  </div>
  
  <!-- Soru Düzenleme Modal -->
  <div id="editQuestionModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">Soru Düzenle</h2>
        <button class="modal-close" onclick="closeModal('editQuestionModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">Soru Metni</label>
        <textarea class="form-textarea" id="editQuestionLabel" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Soru Tipi</label>
        <select class="form-select" id="editQuestionType" onchange="updateQuestionTypeFields()">
          <option value="text">Metin</option>
          <option value="number">Sayısal</option>
          <option value="single">Tek Seçim (Radio)</option>
          <option value="multiple">Çoklu Seçim (Checkbox)</option>
          <option value="likert">Likert Ölçeği</option>
        </select>
      </div>
      <div class="form-group" id="optionsGroup" style="display: none;">
        <label class="form-label">Seçenekler (virgülle ayırın)</label>
        <textarea class="form-textarea" id="editQuestionOptions" rows="3" placeholder="Evet, Hayır, Kararsızım"></textarea>
      </div>
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="editQuestionRequired">
          <span style="font-weight: 600;">Zorunlu Soru</span>
        </label>
      </div>
      <div class="form-group" id="conditionalGroup">
        <label class="form-label">Koşullu Yönlendirme</label>
        <p style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">Bu sorunun yanıtına göre kullanıcıyı farklı sorulara yönlendirin.</p>
        <div id="conditionalLogicContainer"></div>
        <button class="btn btn-outline" style="margin-top: 8px;" onclick="addConditionalRule()">+ Koşul Ekle</button>
      </div>
      <button class="btn btn-primary" style="width: 100%;" onclick="saveQuestionEdit()">Kaydet</button>
    </div>
  </div>
  
  <script>
    // Global state
    let surveys = [];
    let selectedSurvey = null;
    let questions = [];
    let sections = [];
    let currentSection = null;
    let editingQuestionIndex = null;
    let draggedIndex = null;
    
    const TEMPLATES = {
      NPS: [
        { label: "Bizi 0-10 arasında bir arkadaşınıza önerme olasılığınız?", type: "likert", required: true, options: ["0","1","2","3","4","5","6","7","8","9","10"] },
        { label: "Neden bu puanı verdiniz?", type: "text", required: false, options: [] }
      ],
      Likert5: [
        { label: "Genel memnuniyet düzeyiniz", type: "likert", required: true, options: ["1-Kötü","2","3","4","5-Çok İyi"] }
      ],
      Demografi: [
        { label: "Yaş", type: "number", required: false, options: [] },
        { label: "Cinsiyet", type: "single", required: false, options: ["Kadın","Erkek"] },
        { label: "Eğitim Durumu", type: "single", required: false, options: ["İlkokul","Ortaokul","Lise","Üniversite","Lisansüstü"] }
      ],
      Sehir: [
        { label: "Hangi şehirde yaşıyorsunuz?", type: "single", required: true, options: ["Adana","Adıyaman","Afyonkarahisar","Ağrı","Amasya","Ankara","Antalya","Artvin","Aydın","Balıkesir","Bilecik","Bingöl","Bitlis","Bolu","Burdur","Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Edirne","Elazığ","Erzincan","Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkari","Hatay","Isparta","Mersin","İstanbul","İzmir","Kars","Kastamonu","Kayseri","Kırklareli","Kırşehir","Kocaeli","Konya","Kütahya","Malatya","Manisa","Kahramanmaraş","Mardin","Muğla","Muş","Nevşehir","Niğde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Tekirdağ","Tokat","Trabzon","Tunceli","Şanlıurfa","Uşak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman","Kırıkkale","Batman","Şırnak","Bartın","Ardahan","Iğdır","Yalova","Karabük","Kilis","Osmaniye","Düzce"] }
      ]
    };
    
    // Init
    loadSurveys();
    
    async function loadSurveys() {
      const res = await fetch('/api/surveys');
      surveys = await res.json();
      renderSurveysDropdown();
    }
    
    function renderSurveysDropdown() {
      const container = document.getElementById('surveysDropdownContent');
      container.innerHTML = '';
      surveys.forEach(s => {
        const item = document.createElement('div');
        item.className = 'dropdown-item' + (selectedSurvey && selectedSurvey.id === s.id ? ' selected' : '');
        item.innerHTML = `
          <strong>${s.title}</strong><br>
          <small style="color: #6b7280;">/${s.slug}</small>
          <span class="badge ${s.is_active ? 'badge-success' : 'badge-danger'}" style="margin-left: 8px;">
            ${s.is_active ? 'Aktif' : 'Pasif'}
          </span>
        `;
        item.onclick = () => selectSurvey(s);
        container.appendChild(item);
      });
      
      if (surveys.length === 0) {
        container.innerHTML = '<div class="dropdown-item" style="text-align:center; color: #9ca3af;">Henüz anket yok</div>';
      }
    }
    
    function toggleDropdown() {
      document.getElementById('surveysDropdown').classList.toggle('active');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('surveysDropdown');
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });
    
    async function selectSurvey(survey) {
      selectedSurvey = survey;
      document.getElementById('selectedSurveyText').textContent = survey.title;
      document.getElementById('surveysDropdown').classList.remove('active');
      
      // Update UI
      document.getElementById('noSurveyView').classList.remove('active');
      document.getElementById('surveyManagementView').classList.add('active');
      document.getElementById('questionsView').classList.remove('active');
      
      document.getElementById('currentSurveyTitle').textContent = survey.title;
      document.getElementById('currentSurveySlug').textContent = '/' + survey.slug;
      document.getElementById('surveyActiveToggle').checked = survey.is_active;
      
      // Load sections
      await loadSections();
      
      renderSurveysDropdown();
    }
    
    async function loadSections() {
      if (!selectedSurvey) return;
      const res = await fetch(`/api/surveys/${selectedSurvey.id}/sections`);
      sections = await res.json();
    }
    
    function showNewSurveyModal() {
      document.getElementById('newSurveySlug').value = '';
      document.getElementById('newSurveyTitle').value = '';
      document.getElementById('newSurveyModal').classList.add('active');
    }
    
    async function createSurvey() {
      const slug = document.getElementById('newSurveySlug').value.trim();
      const title = document.getElementById('newSurveyTitle').value.trim();
      
      if (!slug || !title) {
        alert('Lütfen tüm alanları doldurun.');
        return;
      }
      
      const res = await fetch('/api/surveys', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug, title, isActive: true })
      });
      
      if (res.ok) {
        const data = await res.json();
        closeModal('newSurveyModal');
        await loadSurveys();
        const newSurvey = surveys.find(s => s.id === data.id);
        if (newSurvey) selectSurvey(newSurvey);
      } else {
        const err = await res.json();
        alert(err.message || 'Hata oluştu');
      }
    }
    
    function showUpdateSurveyModal() {
      if (!selectedSurvey) return;
      document.getElementById('updateSurveySlug').value = selectedSurvey.slug;
      document.getElementById('updateSurveyTitle').value = selectedSurvey.title;
      document.getElementById('updateSurveyModal').classList.add('active');
    }
    
    async function updateSurvey() {
      if (!selectedSurvey) return;
      const slug = document.getElementById('updateSurveySlug').value.trim();
      const title = document.getElementById('updateSurveyTitle').value.trim();
      
      if (!slug || !title) {
        alert('Lütfen tüm alanları doldurun.');
        return;
      }
      
      const res = await fetch(`/api/surveys/${selectedSurvey.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug, title, isActive: selectedSurvey.is_active })
      });
      
      if (res.ok) {
        closeModal('updateSurveyModal');
        selectedSurvey.slug = slug;
        selectedSurvey.title = title;
        await loadSurveys();
        selectSurvey(selectedSurvey);
      } else {
        const err = await res.json();
        alert(err.message || 'Hata oluştu');
      }
    }
    
    async function toggleSurveyActive() {
      if (!selectedSurvey) return;
      const isActive = document.getElementById('surveyActiveToggle').checked;
      
      const res = await fetch(`/api/surveys/${selectedSurvey.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: selectedSurvey.slug, title: selectedSurvey.title, isActive })
      });
      
      if (res.ok) {
        selectedSurvey.is_active = isActive;
        await loadSurveys();
      } else {
        alert('Durum değiştirilemedi');
        document.getElementById('surveyActiveToggle').checked = !isActive;
      }
    }
    
    async function deleteSurvey() {
      if (!selectedSurvey) return;
      if (!confirm(`"${selectedSurvey.title}" anketini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`)) return;
      
      const res = await fetch(`/api/surveys/${selectedSurvey.id}`, { method: 'DELETE' });
      if (res.ok) {
        selectedSurvey = null;
        await loadSurveys();
        document.getElementById('noSurveyView').classList.add('active');
        document.getElementById('surveyManagementView').classList.remove('active');
        document.getElementById('selectedSurveyText').textContent = 'Anket Seçin';
      } else {
        alert('Anket silinemedi');
      }
    }
    
    async function showStatsModal() {
      if (!selectedSurvey) return;
      const res = await fetch(`/api/surveys/${selectedSurvey.id}/stats`);
      const stats = await res.json();
      
      document.getElementById('statsContent').innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${stats.total_responses || 0}</div>
          <div class="stat-label">Toplam Yanıt</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.total_questions || 0}</div>
          <div class="stat-label">Toplam Soru</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.total_invitations || 0}</div>
          <div class="stat-label">Toplam Davetiye</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.used_invitations || 0}</div>
          <div class="stat-label">Kullanılan Davetiye</div>
        </div>
      `;
      document.getElementById('statsModal').classList.add('active');
    }
    
    function exportSurveyData() {
      if (!selectedSurvey) return;
      window.location.href = `/api/surveys/${selectedSurvey.id}/export`;
    }
    
    async function showQuestionsView() {
      if (!selectedSurvey) return;
      
      // Load questions
      const res = await fetch(`/api/surveys/${selectedSurvey.slug}`);
      const data = await res.json();
      questions = data.questions.map(q => ({
        id: q.id,
        section_id: q.section_id,
        ord: q.ord,
        label: q.label,
        type: q.type,
        required: !!q.required,
        options: q.options_json ? JSON.parse(q.options_json) : [],
        conditional_logic: q.conditional_logic ? JSON.parse(q.conditional_logic) : null
      }));
      
      document.getElementById('surveyManagementView').classList.remove('active');
      document.getElementById('questionsView').classList.add('active');
      
      renderQuestions();
    }
    
    function backToSurveyManagement() {
      document.getElementById('questionsView').classList.remove('active');
      document.getElementById('surveyManagementView').classList.add('active');
    }
    
    function toggleSections() {
      const enabled = document.getElementById('sectionsToggle').checked;
      document.getElementById('addSectionBtn').style.display = enabled ? 'block' : 'none';
      document.getElementById('sectionTabs').style.display = enabled ? 'flex' : 'none';
      
      if (enabled) {
        renderSectionTabs();
      } else {
        currentSection = null;
      }
    }
    
    function renderSectionTabs() {
      const container = document.getElementById('sectionTabs');
      container.innerHTML = '';
      
      // "Tüm Sorular" tab
      const allTab = document.createElement('button');
      allTab.className = 'section-tab' + (currentSection === null ? ' active' : '');
      allTab.textContent = 'Tüm Sorular';
      allTab.onclick = () => {
        currentSection = null;
        renderSectionTabs();
        renderQuestions();
      };
      container.appendChild(allTab);
      
      sections.forEach(sec => {
        const tab = document.createElement('button');
        tab.className = 'section-tab' + (currentSection && currentSection.id === sec.id ? ' active' : '');
        tab.innerHTML = `${sec.name} <span class="section-delete" onclick="deleteSection(${sec.id}); event.stopPropagation();">×</span>`;
        tab.onclick = () => {
          currentSection = sec;
          renderSectionTabs();
          renderQuestions();
        };
        container.appendChild(tab);
      });
    }
    
    function showAddSectionModal() {
      document.getElementById('newSectionName').value = '';
      document.getElementById('addSectionModal').classList.add('active');
    }
    
    async function createSection() {
      if (!selectedSurvey) return;
      const name = document.getElementById('newSectionName').value.trim();
      if (!name) {
        alert('Lütfen bölüm adı girin.');
        return;
      }
      
      const res = await fetch(`/api/surveys/${selectedSurvey.id}/sections`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, ord: sections.length + 1 })
      });
      
      if (res.ok) {
        closeModal('addSectionModal');
        await loadSections();
        renderSectionTabs();
      } else {
        alert('Bölüm eklenemedi');
      }
    }
    
    async function deleteSection(sectionId) {
      if (!confirm('Bu bölümü silmek istediğinizden emin misiniz? Bölümdeki sorular genel sorular listesine taşınacak.')) return;
      
      const res = await fetch(`/api/sections/${sectionId}`, { method: 'DELETE' });
      if (res.ok) {
        await loadSections();
        if (currentSection && currentSection.id === sectionId) {
          currentSection = null;
        }
        renderSectionTabs();
        renderQuestions();
      } else {
        alert('Bölüm silinemedi');
      }
    }
    
    function addQuestion() {
      const newQ = {
        id: 0,
        section_id: currentSection ? currentSection.id : null,
        ord: questions.length + 1,
        label: 'Yeni soru',
        type: 'text',
        required: false,
        options: [],
        conditional_logic: null
      };
      questions.push(newQ);
      renderQuestions();
    }
    
    function showTemplatesModal() {
      document.getElementById('templatesModal').classList.add('active');
    }
    
    function applyTemplate(templateName) {
      const template = TEMPLATES[templateName];
      if (!template) return;
      
      const base = questions.length;
      template.forEach((t, i) => {
        questions.push({
          id: 0,
          section_id: currentSection ? currentSection.id : null,
          ord: base + i + 1,
          label: t.label,
          type: t.type,
          required: t.required,
          options: t.options || [],
          conditional_logic: null
        });
      });
      
      closeModal('templatesModal');
      renderQuestions();
    }
    
    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      
      // Filter questions by current section
      let filteredQuestions = questions;
      if (document.getElementById('sectionsToggle').checked && currentSection) {
        filteredQuestions = questions.filter(q => q.section_id === currentSection.id);
      } else if (document.getElementById('sectionsToggle').checked && currentSection === null) {
        // Show all questions
        filteredQuestions = questions;
      }
      
      if (filteredQuestions.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><p>Henüz soru eklenmedi. "+ Soru Ekle" butonuna tıklayın.</p></div>';
        return;
      }
      
      filteredQuestions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.draggable = true;
        card.dataset.index = questions.indexOf(q);
        
        card.ondragstart = (e) => {
          draggedIndex = parseInt(e.target.dataset.index);
          e.target.classList.add('dragging');
        };
        card.ondragend = (e) => {
          e.target.classList.remove('dragging');
        };
        card.ondragover = (e) => e.preventDefault();
        card.ondrop = (e) => {
          e.preventDefault();
          const dropIndex = parseInt(e.currentTarget.dataset.index);
          if (draggedIndex === dropIndex || draggedIndex === null) return;
          
          const [moved] = questions.splice(draggedIndex, 1);
          questions.splice(dropIndex, 0, moved);
          questions = questions.map((qq, i) => ({ ...qq, ord: i + 1 }));
          draggedIndex = null;
          renderQuestions();
        };
        
        card.innerHTML = `
          <div class="question-header">
            <span class="question-order">${q.ord}.</span>
            <div class="question-actions">
              <button class="btn btn-outline" style="padding: 6px 12px; font-size: 13px;" onclick="editQuestion(${questions.indexOf(q)})">✏️ Düzenle</button>
              <button class="btn btn-danger" style="padding: 6px 12px; font-size: 13px;" onclick="deleteQuestion(${questions.indexOf(q)})">🗑️</button>
            </div>
          </div>
          <div style="margin: 12px 0;">
            <strong>${q.label}</strong>
            ${q.required ? '<span class="badge badge-danger" style="margin-left: 8px;">Zorunlu</span>' : ''}
          </div>
          <div style="font-size: 13px; color: #6b7280;">
            Tip: <strong>${q.type}</strong>
            ${q.options && q.options.length > 0 ? ` | Seçenekler: ${q.options.length}` : ''}
            ${q.conditional_logic ? ' | <span style="color: #667eea;">Koşullu Yönlendirme Var</span>' : ''}
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    function editQuestion(index) {
      editingQuestionIndex = index;
      const q = questions[index];
      
      document.getElementById('editQuestionLabel').value = q.label;
      document.getElementById('editQuestionType').value = q.type;
      document.getElementById('editQuestionOptions').value = (q.options || []).join(', ');
      document.getElementById('editQuestionRequired').checked = q.required;
      
      updateQuestionTypeFields();
      renderConditionalLogic(q.conditional_logic);
      
      document.getElementById('editQuestionModal').classList.add('active');
    }
    
    function updateQuestionTypeFields() {
      const type = document.getElementById('editQuestionType').value;
      const optionsGroup = document.getElementById('optionsGroup');
      optionsGroup.style.display = ['single', 'multiple', 'likert'].includes(type) ? 'block' : 'none';
    }
    
    function renderConditionalLogic(logic) {
      const container = document.getElementById('conditionalLogicContainer');
      container.innerHTML = '';
      
      if (!logic || !logic.rules || logic.rules.length === 0) {
        container.innerHTML = '<p style="font-size: 13px; color: #9ca3af;">Henüz koşul eklenmedi.</p>';
        return;
      }
      
      logic.rules.forEach((rule, idx) => {
        const ruleDiv = document.createElement('div');
        ruleDiv.style.cssText = 'background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 8px;';
        ruleDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 13px;">
              Eğer yanıt: <strong>${rule.answer}</strong> ise → <strong>Soru ${rule.nextQuestionOrd}</strong>'a git
            </div>
            <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="removeConditionalRule(${idx})">Sil</button>
          </div>
        `;
        container.appendChild(ruleDiv);
      });
    }
    
    function addConditionalRule() {
      const q = questions[editingQuestionIndex];
      if (!q.conditional_logic) {
        q.conditional_logic = { rules: [] };
      }
      
      const answer = prompt('Hangi yanıt için koşul eklensin?');
      if (!answer) return;
      
      const nextOrd = prompt('Bu yanıt verildiğinde hangi soru sırasına gidilsin?');
      if (!nextOrd) return;
      
      q.conditional_logic.rules.push({ answer, nextQuestionOrd: parseInt(nextOrd) });
      renderConditionalLogic(q.conditional_logic);
    }
    
    function removeConditionalRule(index) {
      const q = questions[editingQuestionIndex];
      if (q.conditional_logic && q.conditional_logic.rules) {
        q.conditional_logic.rules.splice(index, 1);
        renderConditionalLogic(q.conditional_logic);
      }
    }
    
    function saveQuestionEdit() {
      const q = questions[editingQuestionIndex];
      q.label = document.getElementById('editQuestionLabel').value.trim();
      q.type = document.getElementById('editQuestionType').value;
      q.required = document.getElementById('editQuestionRequired').checked;
      
      if (['single', 'multiple', 'likert'].includes(q.type)) {
        const optionsText = document.getElementById('editQuestionOptions').value;
        q.options = optionsText.split(',').map(s => s.trim()).filter(Boolean);
      } else {
        q.options = [];
      }
      
      closeModal('editQuestionModal');
      renderQuestions();
    }
    
    function deleteQuestion(index) {
      if (!confirm('Bu soruyu silmek istediğinizden emin misiniz?')) return;
      questions.splice(index, 1);
      questions = questions.map((q, i) => ({ ...q, ord: i + 1 }));
      renderQuestions();
    }
    
    async function saveQuestions() {
      if (!selectedSurvey) {
        alert('Önce bir anket seçin.');
        return;
      }
      
      const payload = questions.map((q, i) => ({
        id: q.id || 0,
        section_id: q.section_id || null,
        ord: i + 1,
        label: q.label || '',
        type: q.type,
        required: !!q.required,
        options_json: q.options && q.options.length ? JSON.stringify(q.options) : null,
        conditional_logic: q.conditional_logic && q.conditional_logic.rules && q.conditional_logic.rules.length ? JSON.stringify(q.conditional_logic) : null
      }));
      
      const res = await fetch('/api/questions/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ surveyId: selectedSurvey.id, items: payload })
      });
      
      if (res.ok) {
        document.getElementById('statusMessage').textContent = '✅ Sorular başarıyla kaydedildi!';
        setTimeout(() => { document.getElementById('statusMessage').textContent = ''; }, 3000);
        await showQuestionsView(); // Reload questions
      } else {
        const err = await res.json();
        alert('Hata: ' + (err.message || 'Sorular kaydedilemedi'));
      }
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // Close modal on outside click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>
